import streamlit as st
import pandas as pd
from io import BytesIO
import base64

# ========= ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel =========
def to_excel_download(df):
    output = BytesIO()
    # ‚úÖ ‡πÉ‡∏ä‡πâ openpyxl ‡πÅ‡∏ó‡∏ô xlsxwriter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á error
    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        df.to_excel(writer, index=False, sheet_name='Drugs')
    processed_data = output.getvalue()
    b64 = base64.b64encode(processed_data).decode()
    href = f'<a href="data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,{b64}" download="filtered_drugs.xlsx">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel</a>'
    return href

# ========= ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• =========
df = pd.read_excel("druglist.xlsx")

st.title("üíä ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤")

# ========= ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á subtype1_name =========
subtype1_list = df["subtype1_name"].dropna().unique()
selected_subtype1 = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏•‡∏±‡∏Å (subtype1_name)", ["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"] + sorted(list(subtype1_list)))
if selected_subtype1 != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
    df = df[df["subtype1_name"] == selected_subtype1]

# ========= ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á subtype2_name =========
subtype2_list = df["subtype2_name"].dropna().unique()
selected_subtype2 = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≠‡∏á (subtype2_name)", ["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"] + sorted(list(subtype2_list)))
if selected_subtype2 != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
    df = df[df["subtype2_name"] == selected_subtype2]

# ========= ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ drug_name =========
search_text = st.text_input("üîé ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ (drug_name)")
if search_text.strip():
    df = df[df["drug_name"].fillna("").str.contains(search_text, case=False)]

# ========= ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• =========
st.subheader(f"üìã ‡∏û‡∏ö {len(df)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç")

if df.empty:
    st.warning("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å")
else:
    for _, row in df.iterrows():
        st.markdown(f"""
        <div style="background-color: #f0f9ff; padding: 10px; margin-bottom: 10px; border-left: 5px solid #3498db;">
        <strong>‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤:</strong> {row['drug_name']}<br>
        <strong>‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏¢‡∏≤:</strong> {row['account_drug_ID']}
        </div>
        """, unsafe_allow_html=True)

    # ========= ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel =========
    st.markdown("---")
    st.markdown(to_excel_download(df), unsafe_allow_html=True)
